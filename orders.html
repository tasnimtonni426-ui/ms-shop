<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #00d2ff; 
            --dark: #0f172a; 
            --pending: #f1c40f; 
            --shipped: #3498db; 
            --delivered: #2ecc71; 
            --danger: #e74c3c; 
        }
        body { font-family: 'Poppins', sans-serif; background: #f1f5f9; margin: 0; padding: 15px; color: #334155; }
        
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .search-box { 
            display: flex; align-items: center; background: white; padding: 12px 15px; 
            border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 15px;
        }
        .search-box input { border: none; outline: none; width: 100%; margin-left: 10px; font-size: 14px; }

        .tab-menu { display: flex; background: white; border-radius: 12px; padding: 5px; overflow-x: auto; gap: 5px; margin-bottom: 15px; }
        .tab { flex: 1; min-width: 100px; text-align: center; padding: 10px 5px; cursor: pointer; border-radius: 10px; font-size: 11px; font-weight: bold; color: #64748b; }
        .tab.active { background: var(--dark); color: white; }

        .order-card { background: white; border-radius: 18px; padding: 18px; margin-bottom: 15px; border-left: 6px solid #ccc; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .order-id-badge { background: #f1f5f9; color: var(--dark); padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; margin-bottom: 10px; display: inline-block; }
        
        .p-name { font-size: 16px; font-weight: bold; color: var(--dark); margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .info-item { font-size: 12px; color: #475569; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        .info-item i { color: var(--primary); width: 14px; }
        .copy-btn { color: #94a3b8; font-size: 10px; margin-left: auto; }

        .trx-box { background: #e0f2fe; color: #0369a1; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border: 1px dashed #0ea5e9; cursor: pointer; }
        .trx-box .method-info { display: flex; align-items: center; gap: 8px; }
        .trx-box img { width: 22px; height: 22px; object-fit: contain; border-radius: 4px; background: white; padding: 2px; }

        .address-box { background: #f8fafc; padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 12px; border: 1px solid #edf2f7; line-height: 1.6; }
        .total-badge { background: var(--dark); color: var(--primary); padding: 10px; border-radius: 10px; display: flex; justify-content: space-between; margin-top: 10px; font-weight: bold; }

        .s-btns { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 15px; border-top: 1px dashed #eee; padding-top: 10px; }
        .s-btn { flex: 1; min-width: 75px; padding: 8px 2px; border-radius: 8px; border: 1px solid #cbd5e1; background: white; font-size: 9px; cursor: pointer; font-weight: bold; }
        
        .active-Pending { border-color: var(--pending) !important; color: var(--pending); }
        .active-Shipped { border-color: var(--shipped) !important; color: var(--shipped); }
        .active-Delivered { border-color: var(--delivered) !important; color: var(--delivered); }
        .active-Cancelled { border-color: var(--danger) !important; color: var(--danger); }

        .btn-invoice { background: var(--dark); color: white; border: none; padding: 10px; border-radius: 10px; margin-top: 10px; width: 100%; cursor: pointer; font-size: 13px; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; display: none; z-index: 1000; }
    </style>
</head>
<body>

    <div class="toast" id="copyToast">কপি হয়েছে!</div>

    <div class="header">
        <button onclick="location.href='admin_dashboard.html'" style="border:none; background:none; font-size:20px;"><i class="fa fa-arrow-left"></i></button>
        <h2 style="margin:0; font-size:17px;">অর্ডার রিকোয়েস্ট</h2>
    </div>

    <div class="search-box">
        <i class="fa fa-search"></i>
        <input type="text" id="orderSearch" placeholder="আইডি বা নাম দিয়ে খুঁজুন..." onkeyup="handleSearch()">
    </div>

    <div class="tab-menu">
        <div class="tab active" onclick="switchTab('Pending', this)">পেন্ডিং</div>
        <div class="tab" onclick="switchTab('Shipped', this)">শিফট</div>
        <div class="tab" onclick="switchTab('Delivered', this)">ডেলিভারি</div>
        <div class="tab" onclick="switchTab('Cancelled', this)">ক্যানসেল</div>
    </div>

    <div id="orders-list">লোড হচ্ছে...</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCu8lgGs3Q-qLeedhngQAVXtt8BHOAlWDg",
        authDomain: "ms-sp-97f78.firebaseapp.com",
        databaseURL: "https://ms-sp-97f78-default-rtdb.firebaseio.com",
        projectId: "ms-sp-97f78",
        storageBucket: "ms-sp-97f78.appspot.com",
        appId: "1:880638162029:web:b99af5b5518b3e16a13b64"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let currentTab = 'Pending';
    let allOrders = {};

    onValue(ref(db, 'orders'), (snapshot) => {
        allOrders = snapshot.exists() ? snapshot.val() : {};
        renderOrders();
    });

    window.switchTab = (status, el) => {
        currentTab = status;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        renderOrders();
    };

    window.handleSearch = () => {
        const q = document.getElementById('orderSearch').value.toUpperCase();
        renderOrders(q);
    };

    window.copyText = (text) => {
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('copyToast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        });
    };

    function renderOrders(filter = "") {
        const list = document.getElementById('orders-list');
        list.innerHTML = "";
        let count = 0;

        Object.keys(allOrders).reverse().forEach(id => {
            const o = allOrders[id];
            const shortId = id.slice(-6).toUpperCase();
            
            if (o.status === currentTab || filter !== "") {
                if (shortId.includes(filter) || o.userName.toUpperCase().includes(filter)) {
                    count++;
                    list.appendChild(createOrderCard(id, o));
                }
            }
        });
        if (count === 0) list.innerHTML = `<center style="margin-top:50px; color:gray;">কোনো অর্ডার নেই</center>`;
    }

    function createOrderCard(id, o) {
        const card = document.createElement('div');
        card.className = 'order-card';
        card.style.borderLeftColor = getCol(o.status);
        
        let gatewayLogo = "";
        const gatewayName = o.gateway ? o.gateway.toLowerCase() : "";

        if (gatewayName === 'bkash') {
            gatewayLogo = "https://www.logo.wine/a/logo/BKash/BKash-bKash-Logo.wine.svg";
        } else if (gatewayName === 'nagad') {
            gatewayLogo = "https://www.logo.wine/a/logo/Nagad/Nagad-Logo.wine.svg";
        } else {
            gatewayLogo = "https://cdn-icons-png.flaticon.com/512/4341/4341764.png"; 
        }

        const payStatusText = o.paymentType === 'full' ? 'ফুল পেমেন্ট' : 'শুধু চার্জ';
        const payStatusColor = o.paymentType === 'full' ? '#2ecc71' : '#f39c12';

        // ল্যান্ডমার্ক খুঁজে বের করার শক্তিশালী লজিক
        let foundLandmark = 'নেই';
        for (let key in o) {
            if (key.toLowerCase().includes('landmark')) {
                if (o[key] && o[key].toString().trim() !== "") {
                    foundLandmark = o[key];
                    break;
                }
            }
        }

        card.innerHTML = `
            <div class="order-id-badge">ID: #${id.slice(-6).toUpperCase()}</div>
            <div class="p-name">${o.productName || 'স্পোর্টস প্রোডাক্ট'}</div>
            
            <div class="info-grid">
                <div class="info-item"><i class="fa fa-user"></i> ${o.userName}</div>
                <div class="info-item" onclick="copyText('${o.userPhone}')">
                    <i class="fa fa-phone"></i> ${o.userPhone}
                    <i class="fa fa-copy copy-btn"></i>
                </div>
                <div class="info-item"><i class="fa fa-map"></i> ${o.division || 'N/A'}</div>
                <div class="info-item"><i class="fa fa-location-dot"></i> ${o.district || 'N/A'}</div>
            </div>

            <div class="trx-box" onclick="copyText('${o.transactionID || ''}')">
                <div class="method-info">
                    <img src="${gatewayLogo}" alt="${o.gateway}"> 
                    <span>TrxID: ${o.transactionID || 'N/A'}</span>
                </div>
                <i class="fa fa-copy"></i>
            </div>

            <div class="address-box">
                <b>এলাকা:</b> ${o.area || 'N/A'}<br>
                <b>ল্যান্ডমার্ক:</b> ${foundLandmark}
            </div>

            <div class="total-badge">
                <span style="font-size:11px; font-weight:normal; color:#94a3b8;">
                    ${o.gateway ? o.gateway : 'N/A'} (<span style="color:${payStatusColor}">${payStatusText}</span>)
                </span>
                <span>${o.totalAmount || '0 ৳'}</span>
            </div>
            
            <div class="s-btns">
                <button class="s-btn ${o.status === 'Pending' ? 'active-Pending' : ''}" onclick="updateStatus('${id}', 'Pending')">Pending</button>
                <button class="s-btn ${o.status === 'Shipped' ? 'active-Shipped' : ''}" onclick="updateStatus('${id}', 'Shipped')">Shipped</button>
                <button class="s-btn ${o.status === 'Delivered' ? 'active-Delivered' : ''}" onclick="updateStatus('${id}', 'Delivered')">Delivered</button>
                <button class="s-btn ${o.status === 'Cancelled' ? 'active-Cancelled' : ''}" onclick="updateStatus('${id}', 'Cancelled')">Cancel</button>
            </div>
            <button class="btn-invoice" onclick="downloadInvoice('${id}')">Download Invoice</button>
        `;
        return card;
    }

    window.updateStatus = (id, s) => { update(ref(db, 'orders/' + id), { status: s }); };
    
    function getCol(s) { 
        if(s==='Pending') return '#f1c40f';
        if(s==='Shipped') return '#3498db';
        if(s==='Delivered') return '#2ecc71';
        return '#e74c3c';
    }

    window.downloadInvoice = (id) => { alert("ইনভয়েস তৈরির কাজ চলছে..."); };
</script>
</body>
</html>
