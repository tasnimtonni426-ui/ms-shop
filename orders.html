<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #00d2ff; --dark: #0f172a; --pending: #f1c40f; 
            --shipped: #3498db; --delivered: #2ecc71; --danger: #e74c3c; --bg: #f8fafc;
        }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #334155; }
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; background: white; padding: 18px; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .search-box { display: flex; align-items: center; background: white; padding: 12px 18px; border-radius: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .search-box input { border: none; outline: none; width: 100%; margin-left: 10px; font-size: 14px; background: transparent; }
        .tab-menu { display: flex; background: #e2e8f0; border-radius: 14px; padding: 4px; gap: 4px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 10px 5px; cursor: pointer; border-radius: 10px; font-size: 12px; font-weight: 600; color: #64748b; }
        .tab.active { background: white; color: var(--dark); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .order-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid #e2e8f0; position: relative; border-left: 5px solid var(--status-color, #ccc); }
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .order-id { font-size: 11px; font-weight: 700; color: #94a3b8; }
        .status-pill { font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 700; text-transform: uppercase; background: #f1f5f9; }
        .p-name { font-size: 17px; font-weight: 600; color: var(--dark); margin: 0 0 5px 0; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px 0; border-top: 1px solid #f1f5f9; }
        .info-item { font-size: 13px; color: #475569; display: flex; align-items: center; gap: 8px; }
        .address-section { background: #f8fafc; padding: 12px 15px; border-radius: 12px; margin-bottom: 15px; }
        .trx-bar { display: flex; align-items: center; justify-content: space-between; background: #f0f9ff; padding: 12px 15px; border-radius: 12px; margin-bottom: 15px; font-size: 13px; cursor: pointer; }
        .total-section { display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px dashed #e2e8f0; }
        .amount { font-size: 18px; font-weight: 700; }
        .s-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 15px; }
        .s-btn { padding: 8px 2px; border-radius: 8px; border: 1px solid #ddd; background: white; font-size: 10px; font-weight: bold; cursor: pointer; }
        .s-btn.active-Pending { background: var(--pending); color: white; }
        .s-btn.active-Shipped { background: var(--shipped); color: white; }
        .s-btn.active-Delivered { background: var(--delivered); color: white; }
        .s-btn.active-Cancelled { background: var(--danger); color: white; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 10px 24px; border-radius: 30px; display: none; z-index: 9999; }
    </style>
</head>
<body>

    <div class="toast" id="copyToast">কপি করা হয়েছে!</div>

    <div class="header">
        <button onclick="location.href='admin_dashboard.html'" style="border:none; background:none; font-size:20px;"><i class="fa fa-arrow-left"></i></button>
        <h2 style="margin:0; font-size:18px;">অর্ডার ম্যানেজমেন্ট</h2>
    </div>

    <div id="auth-area"></div>

    <div id="admin-content" style="display: none;">
        <div class="search-box">
            <i class="fa fa-search"></i>
            <input type="text" id="orderSearch" placeholder="আইডি বা নাম দিয়ে খুঁজুন..." onkeyup="handleSearch()">
        </div>

        <div class="tab-menu">
            <div class="tab active" onclick="switchTab('Pending', this)">পেন্ডিং</div>
            <div class="tab" onclick="switchTab('Shipped', this)">শিফট</div>
            <div class="tab" onclick="switchTab('Delivered', this)">ডেলিভারি</div>
            <div class="tab" onclick="switchTab('Cancelled', this)">ক্যানসেল</div>
        </div>

        <div id="orders-list">অর্ডার লোড হচ্ছে...</div>
    </div>

<script type="module">
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const auth = getAuth();

// এই ফাংশনটি চেক করবে আপনি লগইন করা কি না
onAuthStateChanged(auth, (user) => {
    if (user && user.email === 'tasnimtonni426@gmail.com') {
        // আপনি লগইন করা আছেন! 
        console.log("Admin Access Granted");
        
        // এখানে আপনার পেজের ডাটা লোড করার মেইন ফাংশনটি কল করুন (যদি থাকে)
        // উদাহরণ: loadOrders(); বা updateCounts();
    } else {
        // লগইন করা না থাকলে সোজা লগইন পেজে পাঠিয়ে দিবে
        alert("দয়া করে আগে লগইন করুন!");
        window.location.href = "login.html"; 
    }
});
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCu8lgGs3Q-qLeedhngQAVXtt8BHOAlWDg",
        authDomain: "ms-sp-97f78.firebaseapp.com",
        databaseURL: "https://ms-sp-97f78-default-rtdb.firebaseio.com",
        projectId: "ms-sp-97f78",
        appId: "1:880638162029:web:b99af5b5518b3e16a13b64"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let currentTab = 'Pending';
    let allOrders = {};

    // সেশন সেভ রাখার জন্য Persistence সেট করা
    setPersistence(auth, browserLocalPersistence);

    // লগইন চেক
    onAuthStateChanged(auth, (user) => {
        if (user && user.email === 'tasnimtonni426@gmail.com') {
            document.getElementById('auth-area').innerHTML = "";
            document.getElementById('admin-content').style.display = "block";
            loadOrders();
        } else {
            document.getElementById('admin-content').style.display = "none";
            document.getElementById('auth-area').innerHTML = `
                <div style="text-align:center; padding:100px 20px;">
                    <i class="fa fa-lock" style="font-size:50px; color:#cbd5e1; margin-bottom:20px;"></i>
                    <h3 style="margin-bottom:10px;">অ্যাডমিন এক্সেস প্রয়োজন</h3>
                    <p style="color:#64748b; font-size:14px; margin-bottom:20px;">নিরাপত্তার জন্য আপনার অ্যাডমিন জিমেইল দিয়ে একবার লগইন করুন।</p>
                    <button id="loginBtn" style="background:var(--primary); color:white; border:none; padding:12px 30px; border-radius:12px; font-weight:bold; cursor:pointer;">Google দিয়ে লগইন করুন</button>
                </div>
            `;
            document.getElementById('loginBtn').onclick = () => {
                signInWithPopup(auth, provider).catch(err => alert("লগইন এরর: " + err.message));
            };
        }
    });

    function loadOrders() {
        onValue(ref(db, 'orders'), (snapshot) => {
            allOrders = snapshot.exists() ? snapshot.val() : {};
            renderOrders();
        });
    }

    window.switchTab = (status, el) => {
        currentTab = status;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        renderOrders();
    };

    window.handleSearch = () => {
        const q = document.getElementById('orderSearch').value.toUpperCase();
        renderOrders(q);
    };

    window.copyText = (text) => {
        if(!text) return;
        navigator.clipboard.writeText(text).then(() => {
            const toast = document.getElementById('copyToast');
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 2000);
        });
    };

    function renderOrders(filter = "") {
        const list = document.getElementById('orders-list');
        list.innerHTML = "";
        let count = 0;

        Object.keys(allOrders).reverse().forEach(id => {
            const o = allOrders[id];
            const userName = (o.userName || "").toUpperCase();
            const orderIdShort = id.slice(-6).toUpperCase();
            
            if (o.status === currentTab || filter !== "") {
                if (userName.includes(filter) || orderIdShort.includes(filter)) {
                    count++;
                    list.appendChild(createOrderCard(id, o));
                }
            }
        });
        if (count === 0) list.innerHTML = `<div style="text-align:center; padding:50px; color:#94a3b8;">কোনো অর্ডার পাওয়া যায়নি</div>`;
    }

    function createOrderCard(id, o) {
        const card = document.createElement('div');
        card.className = 'order-card';
        const color = getCol(o.status);
        card.style.setProperty('--status-color', color);
        
        card.innerHTML = `
            <div class="card-top">
                <span class="order-id">ID: #${id.slice(-6).toUpperCase()}</span>
                <span class="status-pill" style="color:${color}">${o.status}</span>
            </div>
            <h3 class="p-name">${o.productName || 'লোড হচ্ছে...'}</h3>
            <span style="font-size:12px; color:var(--primary); font-weight:600;">Size: ${o.productSize || 'N/A'}</span>
            <div class="info-grid">
                <div class="info-item"><i class="fa fa-user"></i> ${o.userName || 'N/A'}</div>
                <div class="info-item" onclick="copyText('${o.userPhone}')" style="font-weight:bold; color:var(--dark);">
                    <i class="fa fa-phone"></i> ${o.userPhone || 'N/A'}
                </div>
            </div>
            <div class="address-section">
                <div style="font-size:13px; line-height:1.5;"><b>ঠিকানা:</b> ${o.address || 'N/A'}, ${o.area || ''}, ${o.district || ''}</div>
            </div>
            <div class="trx-bar" onclick="copyText('${o.trxID}')">
                <span><b>${o.paymentMethod || 'Pay'}:</b> ${o.trxID || 'N/A'}</span>
                <i class="fa fa-copy"></i>
            </div>
            <div class="total-section">
                <span style="color:#94a3b8; font-size:13px;">Total Amount:</span>
                <span class="amount">${o.totalAmount || o.price || 0} ৳</span>
            </div>
            <div class="s-btns">
                <button class="s-btn ${o.status==='Pending'?'active-Pending':''}" onclick="updateStatus('${id}','Pending')">Pending</button>
                <button class="s-btn ${o.status==='Shipped'?'active-Shipped':''}" onclick="updateStatus('${id}','Shipped')">Shipped</button>
                <button class="s-btn ${o.status==='Delivered'?'active-Delivered':''}" onclick="updateStatus('${id}','Delivered')">Delivered</button>
                <button class="s-btn ${o.status==='Cancelled'?'active-Cancelled':''}" onclick="updateStatus('${id}','Cancelled')">Cancel</button>
            </div>
        `;
        return card;
    }

    window.updateStatus = (id, s) => { 
        update(ref(db, 'orders/' + id), { status: s });
    };
    
    function getCol(s) { 
        if(s==='Pending') return '#f1c40f';
        if(s==='Shipped') return '#3498db';
        if(s==='Delivered') return '#2ecc71';
        return '#e74c3c';
    }
</script>
</body>
</html>
