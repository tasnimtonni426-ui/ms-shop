<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Insights - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #00d2ff; 
            --dark: #0f172a; 
            --success: #2ecc71; 
            --danger: #e74c3c; 
        }
        body { font-family: 'Poppins', sans-serif; background: #f1f5f9; margin: 0; padding: 15px; }
        
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .back-btn { font-size: 20px; color: var(--dark); cursor: pointer; border: none; background: none; }

        .search-container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; margin-top: 10px; }
        .search-box input { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; outline: none; font-size: 14px; }
        .search-box button { background: var(--dark); color: white; border: none; padding: 0 20px; border-radius: 12px; cursor: pointer; font-weight: bold; }

        #profile-card { display: none; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }

        .user-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; text-align: center; }
        #u-img { width: 85px; height: 85px; border-radius: 50%; border: 3px solid var(--primary); margin-bottom: 10px; object-fit: cover; background: #eee; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-item { padding: 15px 5px; border-radius: 15px; text-align: center; color: white; }
        .stat-item b { font-size: 18px; display: block; }
        .stat-item small { font-size: 10px; font-weight: bold; opacity: 0.9; }

        .order-row { background: #f8fafc; padding: 12px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--dark); display: flex; justify-content: space-between; align-items: center; }
        .order-status { font-size: 10px; font-weight: bold; padding: 4px 8px; border-radius: 6px; }

        #loading { display: none; text-align: center; padding: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <button class="back-btn" onclick="location.href='admin_dashboard.html'"><i class="fa fa-arrow-left"></i></button>
        <h2 style="margin:0; font-size:18px;">ইউজার ডিটেইলস</h2>
    </div>

    <div class="search-container">
        <label style="font-size: 13px; font-weight: bold; color: #64748b;">ইউজার আইডি দিন (যেমন: MS-B3COXED3)</label>
        <div class="search-box">
            <input type="text" id="userInput" placeholder="MS-XXXXXXXX">
            <button onclick="searchUser()"><i class="fa fa-search"></i></button>
        </div>
    </div>

    <div id="loading">ডাটা খোঁজা হচ্ছে...</div>

    <div id="profile-card">
        <div class="user-header">
            <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" id="u-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
            <h3 id="u-name">...</h3>
            <p id="u-email">...</p>
            <p id="u-id-display" style="color: var(--primary); font-weight: bold; font-size: 14px; margin-top: 5px;"></p>
        </div>

        <div class="stat-grid">
            <div class="stat-item" style="background: var(--dark);"><b id="total-o">0</b><small>অর্ডার</small></div>
            <div class="stat-item" style="background: var(--success);"><b id="done-o">0</b><small>সফল</small></div>
            <div class="stat-item" style="background: var(--danger);"><b id="cancel-o">0</b><small>বাতিল</small></div>
        </div>

        <div style="font-weight: bold; margin-bottom: 10px;">অর্ডার হিস্ট্রি:</div>
        <div id="user-history"></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCu8lgGs3Q-qLeedhngQAVXtt8BHOAlWDg",
        authDomain: "ms-sp-97f78.firebaseapp.com",
        databaseURL: "https://ms-sp-97f78-default-rtdb.firebaseio.com",
        projectId: "ms-sp-97f78",
        storageBucket: "ms-sp-97f78.appspot.com",
        appId: "1:880638162029:web:b99af5b5518b3e16a13b64"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.searchUser = async () => {
        let input = document.getElementById('userInput').value.trim().toUpperCase();
        if(!input) return alert("আইডি লিখুন!");

        const loading = document.getElementById('loading');
        const profile = document.getElementById('profile-card');
        
        loading.style.display = 'block';
        profile.style.display = 'none';

        let searchTag = input.replace("MS-", "");

        try {
            const usersRef = ref(db, 'users');
            const userSnap = await get(usersRef);
            let foundFullUid = null;
            let userData = null;

            if (userSnap.exists()) {
                userSnap.forEach(child => {
                    const fullUid = child.key; 
                    if (fullUid.toUpperCase().endsWith(searchTag)) {
                        foundFullUid = fullUid;
                        userData = child.val();
                    }
                });
            }

            if (foundFullUid && userData) {
                // নাম এবং ইমেইল লোড করা (বিভিন্ন ফিল্ড নাম চেক করা হচ্ছে)
                const name = userData.displayName || userData.name || userData.userName || "নাম পাওয়া যায়নি";
                const email = userData.email || userData.userEmail || "ইমেইল পাওয়া যায়নি";
                // ইমেজ লোড করা (বিভিন্ন সম্ভাব্য ফিল্ড নাম চেক করা হচ্ছে)
                const photo = userData.photoURL || userData.profilePic || userData.image || userData.userImage;

                const ordersRef = ref(db, 'orders');
                const orderSnap = await get(ordersRef);
                
                let userOrders = [];
                let total = 0, done = 0, cancel = 0;

                if (orderSnap.exists()) {
                    orderSnap.forEach(child => {
                        const o = child.val();
                        if (o.userId === foundFullUid || o.uid === foundFullUid) {
                            userOrders.push(o);
                            total++;
                            if(['Delivered', 'Completed', 'Success'].includes(o.status)) done++;
                            if(o.status === 'Cancelled') cancel++;
                        }
                    });
                }

                loading.style.display = 'none';
                profile.style.display = 'block';
                
                document.getElementById('u-name').innerText = name;
                document.getElementById('u-email').innerText = email;
                document.getElementById('u-id-display').innerText = "MS-" + foundFullUid.slice(-8).toUpperCase();
                
                // ইমেজ সেট করা
                if(photo) {
                    document.getElementById('u-img').src = photo;
                }

                document.getElementById('total-o').innerText = total;
                document.getElementById('done-o').innerText = done;
                document.getElementById('cancel-o').innerText = cancel;

                const historyDiv = document.getElementById('user-history');
                historyDiv.innerHTML = userOrders.length > 0 ? 
                    userOrders.reverse().map(order => `
                        <div class="order-row">
                            <div class="order-info">
                                <b>${order.productName || 'পণ্য'}</b><br>
                                <small>${order.date || ''} | ${order.totalPrice || order.price}৳</small>
                            </div>
                            <span class="order-status" style="background:${getStatusBg(order.status)}; color:white">
                                ${order.status}
                            </span>
                        </div>
                    `).join('') : "<p style='text-align:center;'>কোনো অর্ডার পাওয়া যায়নি।</p>";

            } else {
                loading.style.display = 'none';
                alert("দুঃখিত, এই লাস্ট ৮ ডিজিটের কোনো ইউজার পাওয়া যায়নি!");
            }
        } catch (e) {
            loading.style.display = 'none';
            alert("সার্ভার ত্রুটি!");
            console.error(e);
        }
    };

    function getStatusBg(s) {
        if(['Pending', 'Processing'].includes(s)) return '#f1c40f';
        if(['Shipped', 'On Way'].includes(s)) return '#3498db';
        if(['Delivered', 'Completed', 'Success'].includes(s)) return '#2ecc71';
        return '#e74c3c';
    }
</script>
</body>
</html>
