<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Insights - Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { 
            --primary: #00d2ff; 
            --dark: #0f172a; 
            --success: #2ecc71; 
            --danger: #e74c3c; 
            --warning: #f1c40f; 
        }
        body { font-family: 'Poppins', sans-serif; background: #f1f5f9; margin: 0; padding: 15px; }
        
        .header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .back-btn { font-size: 20px; color: var(--dark); cursor: pointer; border: none; background: none; }

        .search-container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; margin-top: 10px; }
        .search-box input { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 12px; outline: none; font-size: 14px; transition: 0.3s; }
        .search-box input:focus { border-color: var(--primary); }
        .search-box button { background: var(--dark); color: white; border: none; padding: 0 20px; border-radius: 12px; cursor: pointer; font-weight: bold; }

        #profile-card { display: none; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .user-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .user-header h3 { margin: 0; color: var(--dark); }
        .user-header p { margin: 5px 0 0; font-size: 13px; color: #64748b; }

        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-item { padding: 15px 5px; border-radius: 15px; text-align: center; color: white; }
        .stat-item b { font-size: 18px; display: block; }
        .stat-item small { font-size: 10px; text-transform: uppercase; font-weight: bold; opacity: 0.9; }

        .history-title { font-size: 15px; font-weight: bold; color: var(--dark); margin-bottom: 10px; }
        .order-row { background: #f8fafc; padding: 12px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--dark); display: flex; justify-content: space-between; align-items: center; }
        .order-info b { font-size: 13px; display: block; color: var(--dark); }
        .order-info small { font-size: 11px; color: #64748b; }
        .order-status { font-size: 10px; font-weight: bold; padding: 4px 8px; border-radius: 6px; }

        #loading { display: none; text-align: center; padding: 20px; color: var(--dark); font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <button class="back-btn" onclick="location.href='admin_dashboard.html'"><i class="fa fa-arrow-left"></i></button>
        <h2 style="margin:0; font-size:18px;">ইউজার ইন্সাইটস</h2>
    </div>

    <div class="search-container">
        <label style="font-size: 13px; font-weight: bold; color: #64748b;">ইউজার আইডি দিয়ে খুঁজুন (শেষ ৮ বা ৬ অক্ষর)</label>
        <div class="search-box">
            <input type="text" id="userInput" placeholder="উদা: MS-A1B2C3D4">
            <button onclick="searchUser()"><i class="fa fa-search"></i></button>
        </div>
    </div>

    <div id="loading">অনুসন্ধান করা হচ্ছে...</div>

    <div id="profile-card">
        <div class="user-header">
            <h3 id="u-name">লোডিং...</h3>
            <p id="u-email">---</p>
            <p id="u-id" style="color: var(--primary); font-weight: bold; font-size: 12px; margin-top: 5px;"></p>
        </div>

        <div class="stat-grid">
            <div class="stat-item" style="background: var(--dark);">
                <b id="total-o">0</b><small>মোট অর্ডার</small>
            </div>
            <div class="stat-item" style="background: var(--success);">
                <b id="done-o">0</b><small>ডেলিভারি</small>
            </div>
            <div class="stat-item" style="background: var(--danger);">
                <b id="cancel-o">0</b><small>ক্যানসেল</small>
            </div>
        </div>

        <div class="history-title">অর্ডার হিস্ট্রি:</div>
        <div id="user-history"></div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCu8lgGs3Q-qLeedhngQAVXtt8BHOAlWDg",
        authDomain: "ms-sp-97f78.firebaseapp.com",
        databaseURL: "https://ms-sp-97f78-default-rtdb.firebaseio.com",
        projectId: "ms-sp-97f78",
        storageBucket: "ms-sp-97f78.appspot.com",
        appId: "1:880638162029:web:b99af5b5518b3e16a13b64"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.searchUser = async () => {
        let inputId = document.getElementById('userInput').value.trim().toUpperCase();
        if(!inputId) return alert("অনুগ্রহ করে একটি আইডি লিখুন!");
        
        // যদি ইউজার MS- আইডি লিখে থাকে তা রিমুভ করা
        if(inputId.startsWith("MS-")) inputId = inputId.replace("MS-", "");

        const loading = document.getElementById('loading');
        const profile = document.getElementById('profile-card');
        
        loading.style.display = 'block';
        profile.style.display = 'none';

        try {
            // ১. প্রথমে ইউজার ডাটা খোঁজা
            const usersRef = ref(db, 'users');
            const userSnap = await get(usersRef);
            let foundUserId = null;
            let userData = null;

            if (userSnap.exists()) {
                userSnap.forEach(child => {
                    const fullId = child.key.toUpperCase();
                    // আইডির শেষ অংশ ম্যাচ করা (৮ অক্ষর বা ৬ অক্ষর)
                    if (fullId.endsWith(inputId)) {
                        foundUserId = child.key;
                        userData = child.val();
                    }
                });
            }

            if (foundUserId) {
                // ২. যদি ইউজার পাওয়া যায়, তার অর্ডারগুলো খোঁজা
                const ordersRef = ref(db, 'orders');
                const orderSnap = await get(ordersRef);
                
                let userOrders = [];
                let total = 0, done = 0, cancel = 0;

                if (orderSnap.exists()) {
                    orderSnap.forEach(child => {
                        const o = child.val();
                        if (o.userId === foundUserId || o.uid === foundUserId) {
                            userOrders.push(o);
                            total++;
                            if(o.status === 'Delivered' || o.status === 'Completed') done++;
                            if(o.status === 'Cancelled') cancel++;
                        }
                    });
                }

                // ৩. স্ক্রিনে ডাটা দেখানো
                loading.style.display = 'none';
                profile.style.display = 'block';
                
                document.getElementById('u-name').innerText = userData.displayName || userData.name || "নাম পাওয়া যায়নি";
                document.getElementById('u-email').innerText = userData.email || "ইমেইল পাওয়া যায়নি";
                document.getElementById('u-id').innerText = "ইউজার আইডি: MS-" + foundUserId.slice(-8).toUpperCase();
                document.getElementById('total-o').innerText = total;
                document.getElementById('done-o').innerText = done;
                document.getElementById('cancel-o').innerText = cancel;

                const historyDiv = document.getElementById('user-history');
                if(userOrders.length > 0) {
                    historyDiv.innerHTML = userOrders.reverse().map(order => `
                        <div class="order-row">
                            <div class="order-info">
                                <b>${order.productName || 'প্রোডাক্ট নাম নেই'}</b>
                                <small>${order.date || 'তারিখ নেই'} | ${order.totalPrice || order.price}৳</small>
                            </div>
                            <span class="order-status" style="background:${getStatusBg(order.status)}; color:white">
                                ${order.status}
                            </span>
                        </div>
                    `).join('');
                } else {
                    historyDiv.innerHTML = "<p style='text-align:center; font-size:12px; color:#64748b;'>কোনো অর্ডারের তথ্য পাওয়া যায়নি।</p>";
                }

            } else {
                loading.style.display = 'none';
                alert("দুঃখিত, এই আইডিতে কোনো ইউজার পাওয়া যায়নি!");
            }
        } catch (error) {
            console.error(error);
            loading.style.display = 'none';
            alert("সার্ভার সমস্যা! আবার চেষ্টা করুন।");
        }
    };

    function getStatusBg(s) {
        if(s==='Pending') return '#f1c40f';
        if(s==='Shipped') return '#3498db';
        if(s==='Delivered' || s==='Completed') return '#2ecc71';
        return '#e74c3c';
    }
</script>
</body>
</html>
