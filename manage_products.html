<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products | MS STORE Admin</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #0ea5e9; 
            --dark: #0f172a; 
            --bg: #f8fafc; 
            --surface: #ffffff; 
            --border: #e2e8f0; 
            --danger: #ef4444;
            --success: #10b981;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        
        @keyframes pageFade {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 15px; 
            padding-bottom: 50px; 
            color: var(--dark);
            animation: pageFade 0.5s ease-out;
        }
        
        /* Top Bar */
        .top-bar { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .back-btn { 
            font-size: 20px; color: var(--dark); cursor: pointer; text-decoration: none; 
            width: 40px; height: 40px; display: flex; align-items: center; 
            justify-content: center; background: white; border-radius: 50%; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        
        /* Cards */
        .card { 
            background: var(--surface); 
            padding: 20px; 
            border-radius: 24px; 
            border: 1px solid var(--border); 
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); 
        }
        h3 { margin-top: 0; font-size: 18px; color: var(--dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }

        /* Form Inputs */
        label { font-size: 12px; font-weight: 700; color: #64748b; margin-left: 5px; display: block; margin-top: 10px; }
        input, textarea, select { 
            width: 100%; padding: 12px; margin: 8px 0; 
            border: 1.5px solid var(--border); border-radius: 12px; 
            outline: none; box-sizing: border-box; font-family: inherit; 
            transition: 0.3s; background: #fcfdfe;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); background: #fff; 
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); 
        }
        
        .btn-main { 
            background: var(--dark); color: white; border: none; padding: 15px; 
            width: 100%; border-radius: 14px; font-weight: 700; cursor: pointer; 
            font-size: 15px; transition: 0.3s; margin-top: 10px;
        }
        .btn-main:active { transform: scale(0.98); }
        .btn-main:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Inventory List */
        .p-item { 
            display: flex; align-items: center; gap: 12px; padding: 12px; 
            background: white; border-radius: 16px; margin-bottom: 10px; 
            border: 1px solid var(--border); transition: 0.3s;
            animation: pageFade 0.4s ease-out;
        }
        .p-item img { width: 55px; height: 55px; border-radius: 12px; object-fit: cover; background: #f1f5f9; }
        .p-info { flex: 1; }
        .p-info b { font-size: 14px; display: block; color: var(--dark); margin-bottom: 2px; }
        .p-info small { color: var(--primary); font-weight: 700; }
        
        .action-btns { display: flex; gap: 8px; }
        .action-btn { 
            border: none; width: 36px; height: 36px; border-radius: 10px; 
            cursor: pointer; display: flex; align-items: center; 
            justify-content: center; transition: 0.2s; 
        }
        .btn-edit { background: #e0f2fe; color: #0ea5e9; }
        .btn-del { background: #fee2e2; color: #ef4444; }

        /* Toast & Loader */
        .toast { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); 
            background: var(--dark); color: white; padding: 12px 25px; 
            border-radius: 30px; display: none; z-index: 2000; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); font-weight: 600; 
        }
        #auth-loader { 
            position: fixed; inset: 0; background: white; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; z-index: 10000; 
        }
        .spinner { 
            width: 35px; height: 35px; border: 4px solid #f1f5f9; 
            border-top: 4px solid var(--primary); border-radius: 50%; 
            animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Auth Protection Screen -->
    <div id="auth-loader">
        <div class="spinner"></div>
        <p style="font-weight: 600; color: #64748b;">‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
    </div>

    <div class="top-bar">
        <a href="admin.html" class="back-btn"><i class="fa fa-arrow-left"></i></a>
        <h2 style="margin:0; font-size: 18px; font-weight: 700;">Manage Inventory</h2>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Product Form -->
    <div class="card">
        <h3 id="form-title">üöÄ Add New Product</h3>
        <input type="hidden" id="edit-id"> 
        
        <label>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
        <input type="text" id="p-name" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: Premium Leather Boots">
        
        <div style="display: flex; gap: 10px;">
            <div style="flex:1">
                <label>‡¶Æ‡ßá‡¶á‡¶® ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</label>
                <select id="p-main-category" onchange="window.updateSubCats()">
                    <option value="" disabled selected>Select</option>
                    <option value="Sports">Sports</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Fashion">Fashion</option>
                </select>
            </div>
            <div style="flex:1">
                <label>‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</label>
                <select id="p-category"><option value="" disabled selected>Sub-Category</option></select>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px;">
            <div style="flex:1">
                <label>‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø (‡ß≥)</label>
                <input type="number" id="p-price" placeholder="0">
            </div>
            <div style="flex:1">
                <label>‡¶∏‡ßç‡¶ü‡¶ï ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                <input type="number" id="p-stock" placeholder="0">
            </div>
        </div>
        
        <label>‡¶õ‡¶¨‡¶ø‡¶∞ ‡¶á‡¶â‡¶Ü‡¶∞‡¶è‡¶≤ (Direct Link)</label>
        <input type="text" id="p-img" placeholder="https://example.com/image.jpg">
        
        <label>‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
        <textarea id="p-desc" placeholder="‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." rows="3"></textarea>
        
        <button class="btn-main" id="uploadBtn">Publish Product</button>
        <button class="btn-main" id="updateBtn" style="display:none; background: #6366f1;">Update Product</button>
    </div>

    <!-- Inventory List -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin:0;">üì¶ Inventory List</h3>
            <span id="product-count" style="font-size: 12px; font-weight: 700; color: var(--primary);">0 Items</span>
        </div>
        <div id="admin-product-list">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCu8lgGs3Q-qLeedhngQAVXtt8BHOAlWDg",
        authDomain: "ms-sp-97f78.firebaseapp.com",
        databaseURL: "https://ms-sp-97f78-default-rtdb.firebaseio.com",
        projectId: "ms-sp-97f78",
        storageBucket: "ms-sp-97f78.appspot.com",
        appId: "1:880638162029:web:b99af5b5518b3e16a13b64"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ‡ßß. ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶Ö‡¶•‡ßá‡¶®‡¶ü‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶ö‡ßá‡¶ï
    onAuthStateChanged(auth, (user) => {
        if (user && user.email === 'tasnimtonni426@gmail.com') {
            document.getElementById('auth-loader').style.display = 'none';
        } else {
            alert("Unauthorized Access!");
            window.location.href = "index.html";
        }
    });

    // ‡ß®. ‡¶ü‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®
    function showToast(msg) { 
        const t = document.getElementById('toast'); 
        t.innerText = msg; 
        t.style.display='block'; 
        setTimeout(()=>t.style.display='none', 3000); 
    }

    // ‡ß©. ‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶ó‡¶∞‡¶ø ‡¶°‡¶æ‡¶á‡¶®‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶≤‡ßã‡¶°
    window.updateSubCats = () => {
        const main = document.getElementById('p-main-category').value;
        const sub = document.getElementById('p-category');
        const options = { 
            'Sports':['Jersey','Boots', 'Equipment', 'Others'], 
            'Electronics':['Gadget','Mobile', 'Accessories', 'Audio'], 
            'Fashion':['Men','Women', 'Shoes', 'Watches'] 
        };
        sub.innerHTML = '<option value="" disabled selected>Sub-Category</option>';
        if(options[main]) options[main].forEach(s => sub.innerHTML += `<option value="${s}">${s}</option>`);
    };

    // ‡ß™. ‡¶á‡¶®‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∞‡¶ø ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° (‡¶∞‡¶ø‡ßü‡ßá‡¶≤-‡¶ü‡¶æ‡¶á‡¶Æ)
    onValue(ref(db, 'products'), (snap) => {
        const list = document.getElementById('admin-product-list');
        const countBox = document.getElementById('product-count');
        list.innerHTML = "";
        if(snap.exists()){
            let count = 0;
            snap.forEach(c => {
                count++;
                const p = c.val();
                list.innerHTML += `
                    <div class="p-item">
                        <img src="${p.img}" onerror="this.src='https://via.placeholder.com/60?text=No+Img'">
                        <div class="p-info">
                            <b>${p.name}</b>
                            <small>‡ß≥ ${p.price}</small>
                        </div>
                        <div class="action-btns">
                            <button class="action-btn btn-edit" onclick="window.editProduct('${c.key}')" title="Edit"><i class="fa fa-pen"></i></button>
                            <button class="action-btn btn-del" onclick="window.deleteItem('${c.key}')" title="Delete"><i class="fa fa-trash"></i></button>
                        </div>
                    </div>`;
            });
            countBox.innerText = count + " Items";
        } else { 
            list.innerHTML = "<p style='text-align:center; color:#94a3b8;'>Inventory is empty.</p>";
            countBox.innerText = "0 Items";
        }
    });

    // ‡ß´. ‡¶°‡ßá‡¶ü‡¶æ ‡¶≠‡ßç‡¶Ø‡¶æ‡¶≤‡¶ø‡¶°‡ßá‡¶∂‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function getProductData() {
        const name = document.getElementById('p-name').value.trim();
        const mainCat = document.getElementById('p-main-category').value;
        const subCat = document.getElementById('p-category').value;
        const price = document.getElementById('p-price').value;
        const stock = document.getElementById('p-stock').value;
        const img = document.getElementById('p-img').value.trim();
        const desc = document.getElementById('p-desc').value.trim();

        if(!name || !price || !mainCat || !img) {
            alert("‡¶∏‡¶¨‡¶ó‡ßÅ‡¶≤‡ßã ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!");
            return null;
        }

        return {
            name,
            category: mainCat,
            subCategory: subCat || "General",
            price: parseInt(price),
            stock: parseInt(stock) || 0,
            img,
            description: desc || ""
        };
    }

    // ‡ß¨. ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶∂
    document.getElementById('uploadBtn').onclick = function() {
        const data = getProductData();
        if(!data) return;

        this.disabled = true;
        push(ref(db, 'products'), data).then(() => {
            showToast("‚úÖ Product Added!");
            resetForm();
        }).catch(e => alert("Error: " + e.message))
        .finally(() => this.disabled = false);
    };

    // ‡ß≠. ‡¶è‡¶°‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Global Scope)
    window.editProduct = (id) => {
        get(ref(db, 'products/' + id)).then(s => {
            if(s.exists()){
                const p = s.val();
                document.getElementById('edit-id').value = id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-main-category').value = p.category;
                window.updateSubCats(); 
                document.getElementById('p-category').value = p.subCategory;
                document.getElementById('p-price').value = p.price;
                document.getElementById('p-stock').value = p.stock || 0;
                document.getElementById('p-img').value = p.img;
                document.getElementById('p-desc').value = p.description || "";
                
                document.getElementById('form-title').innerText = "üìù Edit Product";
                document.getElementById('uploadBtn').style.display = 'none';
                document.getElementById('updateBtn').style.display = 'block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    };

    // ‡ßÆ. ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
    document.getElementById('updateBtn').onclick = function() {
        const id = document.getElementById('edit-id').value;
        const data = getProductData();
        if(!id || !data) return;

        this.disabled = true;
        update(ref(db, 'products/' + id), data).then(() => {
            showToast("üîÑ Product Updated!");
            resetForm();
        }).catch(e => alert("Error: " + e.message))
        .finally(() => this.disabled = false);
    };

    // ‡ßØ. ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Global Scope)
    window.deleteItem = (id) => { 
        if(confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
            remove(ref(db, 'products/' + id))
                .then(() => showToast("üóëÔ∏è Product Removed!"))
                .catch(e => alert("Delete Error: " + e.message));
        }
    };

    // ‡¶´‡¶∞‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
    function resetForm() {
        document.getElementById('edit-id').value = "";
        document.getElementById('p-name').value = "";
        document.getElementById('p-price').value = "";
        document.getElementById('p-stock').value = "";
        document.getElementById('p-img').value = "";
        document.getElementById('p-desc').value = "";
        document.getElementById('p-main-category').selectedIndex = 0;
        document.getElementById('p-category').innerHTML = '<option value="" disabled selected>Sub-Category</option>';
        document.getElementById('form-title').innerText = "üöÄ Add New Product";
        document.getElementById('uploadBtn').style.display = 'block';
        document.getElementById('updateBtn').style.display = 'none';
    }
</script>
</body>
        </html>
